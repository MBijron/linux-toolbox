#!/bin/bash

c_choose_and_cd() {
    local results="$1"
    local preferred_index="$2"
    local open_in_code="$3"
    local color_index=""
    local color_abbr=""
    local color_name=""
    local color_path=""
    local color_reset=""
    local count
    local chosen_path
    local selection
    local clean_results

    if [[ "$open_in_code" != "1" ]]; then
        open_in_code="0"
    fi

    if [[ -z "$results" ]]; then
        echo "No matching repository found."
        return 1
    fi

    clean_results="$(printf '%s\n' "$results" | awk 'NF')"
    count="$(printf '%s\n' "$clean_results" | awk 'NF {c++} END {print c+0}')"

    if [[ "$count" -eq 0 ]]; then
        echo "No matching repository found."
        return 1
    fi

    if [[ "$count" -eq 1 ]]; then
        chosen_path="$(printf '%s\n' "$clean_results" | awk -F '\t' 'NF {print $1; exit}')"
        if [[ -z "$chosen_path" ]]; then
            echo "No matching repository found."
            return 1
        fi
        if [[ "$open_in_code" == "1" ]]; then
            code "$chosen_path" || return 1
        else
            cd "$chosen_path" || return 1
        fi
        return 0
    fi

    if [[ -t 1 ]]; then
        color_index=$'\033[1;33m'
        color_abbr=$'\033[1;36m'
        color_name=$'\033[0;37m'
        color_path=$'\033[0;90m'
        color_reset=$'\033[0m'
    fi

    echo "Multiple matches found:"
    local index
    local item_path
    local item_name
    local item_abbr
    local tab_after_abbr
    local tab_after_name
    local current_line
    for ((index = 0; index < count; index++)); do
        current_line="$(printf '%s\n' "$clean_results" | sed -n "$((index + 1))p")"
        IFS=$'\t' read -r item_path item_name item_abbr <<< "$current_line"

        tab_after_abbr=$'\t'
        if ((${#item_abbr} < 8)); then
            tab_after_abbr+=$'\t'
        fi

        tab_after_name=$'\t'
        if ((${#item_name} < 24)); then
            tab_after_name+=$'\t'
        fi

        printf '%b%d)%b\t%b%s%b%s%b%s%b%s%b%s%b\n' \
            "$color_index" "$((index + 1))" "$color_reset" \
            "$color_abbr" "$item_abbr" "$color_reset" \
            "$tab_after_abbr" \
            "$color_name" "$item_name" "$color_reset" \
            "$tab_after_name" \
            "$color_path" "$item_path" "$color_reset"
    done

    if [[ "$preferred_index" =~ ^[0-9]+$ ]] && ((preferred_index >= 1 && preferred_index <= count)); then
        chosen_path="$(printf '%s\n' "$clean_results" | sed -n "${preferred_index}p" | awk -F '\t' '{print $1}')"
        if [[ -z "$chosen_path" ]]; then
            echo "No matching repository found."
            return 1
        fi
        if [[ "$open_in_code" == "1" ]]; then
            code "$chosen_path" || return 1
        else
            cd "$chosen_path" || return 1
        fi
        return 0
    fi

    while true; do
        printf 'Pick one (1-%d): ' "$count"
        read -r selection

        if [[ "$selection" =~ ^[0-9]+$ ]] && ((selection >= 1 && selection <= count)); then
            chosen_path="$(printf '%s\n' "$clean_results" | sed -n "${selection}p" | awk -F '\t' '{print $1}')"
            if [[ -z "$chosen_path" ]]; then
                echo "No matching repository found."
                return 1
            fi
            if [[ "$open_in_code" == "1" ]]; then
                code "$chosen_path" || return 1
            else
                cd "$chosen_path" || return 1
            fi
            return 0
        fi

        echo "Invalid choice."
    done
}