#!/bin/bash

code() {
    local target="${1:-.}"
    local executable_path
    local distro_name
    local wsl_target
    local windows_target
    local remote_authority
    local remote_uri
    local uri_flag

    executable_path="$(code_get_insiders_executable_path)"
    code_validate_executable_exists "$executable_path" || return $?

    wsl_target="$(code_convert_target_to_wsl_path "$target")" || return $?
    if [ ! -e "$wsl_target" ]; then
        printf '%s\n' 'Using c to resolve path'
        c "$@" -c
        return $?
    fi

    if code_is_windows_mount_path "$wsl_target"; then
        windows_target="$(code_convert_wsl_path_to_windows_path "$wsl_target")" || return $?
        printf '%s\n' "$windows_target"
        code_launch_with_windows_path "$executable_path" "$windows_target" || return $?
        return 0
    fi

    distro_name="$(code_get_wsl_distro_name)" || return $?
    remote_authority="$(code_build_remote_authority "$distro_name")"
    wsl_target="$(code_ensure_path_has_leading_slash "$wsl_target")"
    remote_uri="$(code_build_remote_uri "$remote_authority" "$wsl_target")"
    uri_flag="$(code_choose_uri_flag_for_target "$target" "$wsl_target")"

    printf '%s\n' "$remote_uri"
    code_launch_with_uri "$executable_path" "$uri_flag" "$remote_uri" || return $?

    return 0
}
